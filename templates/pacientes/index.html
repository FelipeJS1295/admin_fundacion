{% extends "layouts/base.html" %}
{% block content %}
<h1 class="text-xl font-bold mb-4">Pacientes</h1>

<form method="get" class="grid gap-3 md:grid-cols-6 mb-4">
  <div class="md:col-span-3">
    <label class="block text-sm text-slate-300 mb-1">Buscar</label>
    <input
      type="text"
      name="q"
      value="{{ filtros.q or '' }}"
      placeholder="Nombre, apellido o RUT"
      class="w-full rounded-lg bg-slate-900 border border-slate-800 px-3 py-2"
    >
  </div>

  <div>
    <label class="block text-sm text-slate-300 mb-1">Estado</label>
    <select name="activo" class="w-full rounded-lg bg-slate-900 border border-slate-800 px-3 py-2">
      <option value="">Todos</option>
      <option value="1" {{ 'selected' if filtros.activo == '1' else '' }}>Activos</option>
      <option value="0" {{ 'selected' if filtros.activo == '0' else '' }}>Inactivos</option>
    </select>
  </div>

  <div>
    <label class="block text-sm text-slate-300 mb-1">Límite</label>
    <select name="limit" class="w-full rounded-lg bg-slate-900 border border-slate-800 px-3 py-2">
      {% for n in [25,50,100,200] %}
        <option value="{{ n }}" {{ 'selected' if (filtros.limit|int if filtros.limit else 50)==n else '' }}>{{ n }}</option>
      {% endfor %}
    </select>
  </div>

  <div class="md:col-span-6 flex gap-2">
    <button class="px-4 py-2 rounded-xl bg-slate-800 border border-slate-700 hover:bg-slate-700">Filtrar</button>
    <a href="/pacientes" class="px-4 py-2 rounded-xl bg-slate-800 border border-slate-700 hover:bg-slate-700">Limpiar</a>
    <a href="/pacientes/crear" class="ml-auto px-4 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-500 text-white">Nuevo Paciente</a>
  </div>
</form>

<div class="mb-4 flex items-center justify-between rounded-xl border border-slate-800 bg-slate-900/50 px-4 py-3">
  <span class="text-sm text-slate-300">Total (aplicando filtros)</span>
  <span class="text-2xl font-bold text-emerald-400">
    {{ total_pacientes if total_pacientes is not none else pacientes|length }}
  </span>
</div>

{% macro sort_link(col_key, label) -%}
  {% set is_current = (filtros.sort == col_key) %}
  {% set next_dir = 'asc' if (not is_current or filtros.dir == 'desc') else 'desc' %}
  <a
    href="/pacientes?q={{ filtros.q or '' }}&activo={{ filtros.activo or '' }}&limit={{ filtros.limit or 50 }}&sort={{ col_key }}&dir={{ next_dir }}"
    class="inline-flex items-center gap-1 hover:text-white"
  >
    <span>{{ label }}</span>
    {% if is_current %}
      <span class="text-xs opacity-70">{{ '▲' if filtros.dir == 'asc' else '▼' }}</span>
    {% else %}
      <span class="text-xs opacity-40">⇅</span>
    {% endif %}
  </a>
{%- endmacro %}

<div class="overflow-x-auto rounded-2xl border border-slate-800">
  <table class="min-w-full text-sm">
    <thead class="bg-slate-900 text-slate-300">
      <tr>
        <th class="px-3 py-2 text-left">{{ sort_link('id','ID') }}</th>
        <th class="px-3 py-2 text-left">{{ sort_link('nombre','Nombre') }}</th>
        <th class="px-3 py-2 text-left">{{ sort_link('rut','RUT') }}</th>
        <th class="px-3 py-2 text-left">{{ sort_link('sexo','Sexo') }}</th>
        <th class="px-3 py-2 text-left">{{ sort_link('comuna','Comuna') }}</th>
        <th class="px-3 py-2 text-left">{{ sort_link('activo','Activo') }}</th>
        <th class="px-3 py-2 text-left">Acciones</th>
      </tr>
    </thead>
    <tbody>
      {% for p in pacientes %}
      <tr class="border-t border-slate-800">
        <td class="px-3 py-2">{{ p.id }}</td>
        <td class="px-3 py-2 font-medium">{{ p.nombres }} {{ p.apellidos }}</td>
        <td class="px-3 py-2">{{ p.rut }}</td>
        <td class="px-3 py-2">{{ p.sexo.value if p.sexo else '' }}</td>
        <td class="px-3 py-2">{{ p.comuna.nombre if p.comuna else '' }}</td>
        <td class="px-3 py-2">
          <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-lg text-xs
            {{ 'bg-emerald-900/40 text-emerald-300 border border-emerald-800' if p.activo else 'bg-rose-900/40 text-rose-300 border border-rose-800' }}">
            {{ 'Sí' if p.activo else 'No' }}
          </span>
        </td>
        <td class="px-3 py-2 space-x-2">
          <a class="underline" href="/pacientes/{{ p.id }}">Ver</a>
          <a class="underline" href="/pacientes/{{ p.id }}/editar">Editar</a>
          <form method="post" action="/pacientes/{{ p.id }}/eliminar" class="inline" onsubmit="return confirm('¿Eliminar paciente?');">
            <button class="underline text-rose-300">Eliminar</button>
          </form>
        </td>
      </tr>
      {% else %}
      <tr><td class="px-3 py-4 text-slate-400" colspan="7">Sin resultados.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}
